# 케르베로스(Kerberos) 인증 프로토콜 설명

## 1. 케르베로스란?

케르베로스는 **안전하지 않은 네트워크(예: 인터넷)에서 사용자와 서비스가 서로의 신원을 안전하게 확인할 수 있도록 설계된 컴퓨터 네트워크 인증 프로토콜**입니다. 1980년대 MIT에서 개발했으며, 네트워크상에 비밀번호가 그대로 전송되는 것을 막기 위해 만들어졌습니다.

## 2. 핵심 개념: 신뢰할 수 있는 제3자와 티켓

케르베로스는 '신뢰할 수 있는 제3자'와 '티켓'이라는 두 가지 핵심 개념을 사용합니다. 사용자가 특정 서비스를 이용할 때마다 비밀번호를 보내는 대신, 중앙 인증 기관(KDC)에서 발급하는 암호화된 임시 티켓을 사용하여 신원을 증명합니다. 이를 통해 **사용자와 서버가 서로를 인증하는 상호 인증(Mutual Authentication)**이 가능해집니다.

## 3. 주요 구성 요소

케르베로스 시스템은 크게 세 부분으로 구성됩니다.

1.  **클라이언트 (Client):** 서비스에 접근하려는 사용자 또는 프로그램입니다.
2.  **서버 (Server):** 클라이언트가 접근하려는 애플리케이션 또는 서비스입니다.
3.  **키 분배 센터 (Key Distribution Center, KDC):** 신뢰할 수 있는 제3자로서, 사용자 인증과 티켓 발급을 책임집니다. KDC는 두 가지 서버로 구성됩니다.
    *   **인증 서버 (Authentication Server, AS):** 사용자의 초기 인증을 수행하고, '티켓 발급 티켓(TGT)'이라는 것을 발급합니다.
    *   **티켓 발급 서버 (Ticket-Granting Server, TGS):** 클라이언트가 특정 서비스에 접근할 수 있도록 '서비스 티켓'을 발급합니다.

## 4. 인증 동작 방식 (간단한 단계)

1.  **초기 인증 (AS):**
    *   사용자가 로그인하면, 클라이언트는 사용자 비밀번호를 기반으로 암호화된 요청을 **인증 서버(AS)**로 보냅니다.
    *   AS는 요청이 유효하면 '티켓 발급 티켓(TGT)'을 암호화하여 클라이언트에게 보내줍니다. 이 TGT는 클라이언트가 다른 서비스 티켓을 요청할 자격이 있음을 증명합니다.

2.  **서비스 티켓 요청 (TGS):**
    *   클라이언트는 특정 서버(예: 파일 서버)에 접근하기 위해, 앞서 받은 TGT를 **티켓 발급 서버(TGS)**에 제시합니다.
    *   TGS는 TGT를 확인하고, 해당 서버에 접근할 수 있는 '서비스 티켓'을 발급하여 클라이언트에게 전달합니다.

3.  **서비스 접근 (서버):**
    *   클라이언트는 TGS로부터 받은 '서비스 티켓'을 최종 목적지인 **서버**에 제출합니다.
    *   서버는 서비스 티켓을 확인하여 클라이언트의 신원을 검증하고, 인증이 성공하면 서비스를 제공합니다.

## 5. 주요 장점

*   **강력한 보안:** 비밀번호가 네트워크를 통해 직접 전송되지 않아 도청으로부터 안전합니다.
*   **상호 인증:** 클라이언트와 서버가 서로의 신원을 확인하여 중간자 공격(man-in-the-middle attack)을 방지합니다.
*   **싱글 사인온 (Single Sign-On, SSO):** 사용자는 최초 한 번만 인증하면, 이후 여러 서비스에 접근할 때마다 비밀번호를 입력할 필요가 없습니다.

---

## 6. 심화 질문 (Q&A)

### Q: AS와 TGS는 다른 서버인데 TGS는 클라이언트가 제출한 TGT를 어떻게 검증하나요?

좋은 질문입니다. 그 부분이 바로 케르베로스 프로토콜의 핵심적인 신뢰 구조입니다.

결론부터 말씀드리면, **인증 서버(AS)와 티켓 발급 서버(TGS)는 KDC(키 분배 센터) 내에 함께 있으며, 둘만이 아는 비밀 키(Secret Key)를 공유**하기 때문입니다.

자세한 과정은 다음과 같습니다.

1.  **TGT 발급 (AS의 역할):**
    *   사용자가 처음 로그인을 시도하면, **인증 서버(AS)**는 사용자의 신원을 확인합니다.
    *   확인이 완료되면, AS는 **TGS의 비밀 키(`K_tgs`)**를 사용하여 '티켓 발급 티켓(TGT)'을 암호화합니다.
    *   이 암호화된 TGT에는 "이 사용자는 내가 인증했음"이라는 정보와 클라이언트-TGS 통신을 위한 세션 키 등이 포함됩니다.
    *   AS는 이 TGT를 클라이언트에게 전달합니다. **클라이언트는 TGS의 비밀 키를 모르기 때문에 TGT의 내용을 열어볼 수 없습니다.**

2.  **TGT 검증 (TGS의 역할):**
    *   클라이언트는 서비스 이용을 위해 이 TGT를 **티켓 발급 서버(TGS)**에 제출합니다.
    *   TGS는 AS와 동일한 TGS 비밀 키(`K_tgs`)를 가지고 있습니다.
    *   TGS는 자신이 가진 이 비밀 키를 사용해 클라이언트가 제출한 TGT의 암호를 해독(복호화)합니다.

**핵심:**

*   만약 TGS가 자신의 비밀 키로 TGT를 성공적으로 복호화할 수 있다면, 이것은 **해당 TGT가 신뢰할 수 있는 AS에 의해 발급되었음을 증명**하는 것이 됩니다. 다른 어떤 존재도 TGS의 비밀 키를 모르기 때문에, 유효한 TGT를 만들어낼 수 없습니다.

간단히 비유하자면, AS와 TGS는 오직 둘만이 가진 특별한 도장(비밀 키)을 가지고 있는 것과 같습니다. AS가 "이 사용자는 신뢰할 수 있음"이라는 문서(TGT)에 특별한 도장을 찍어서 사용자에게 주면, 사용자는 그 문서를 TGS에게 가져갑니다. TGS는 그 도장을 보고 "아, AS가 보낸 게 맞구나"라고 신뢰하고 다음 단계를 진행하는 원리입니다.

### Q: 서비스 티켓이 최종 서버와 통신하는 비밀키인가요?

정확히는, **서비스 티켓은 최종 서버와 통신할 비밀 키(세션 키)를 안전하게 전달하는 '증명서' 또는 '컨테이너'**라고 이해하는 것이 더 정확합니다. 서비스 티켓 자체가 비밀 키는 아닙니다.

조금 더 자세히 설명해 드리겠습니다.

클라이언트가 티켓 발급 서버(TGS)로부터 서비스 티켓을 요청하면, TGS는 두 가지 중요한 것을 암호화하여 클라이언트에게 보냅니다.

1.  **서비스 티켓 (Service Ticket):**
    *   이것은 **최종 서비스 서버의 비밀 키**로 암호화되어 있습니다.
    *   이 안에는 "이 클라이언트는 인증되었음"이라는 정보와 함께, **클라이언트와 최종 서버가 사용할 임시 비밀 키(세션 키)**가 들어있습니다.
    *   클라이언트는 이 티켓을 열어볼 수 없습니다. 최종 서버만이 열 수 있는 '봉인된 편지'와 같습니다.

2.  **클라이언트-서버 세션 키 (Client-Server Session Key):**
    *   이것이 바로 **클라이언트와 최종 서버가 통신할 때 사용할 실제 임시 비밀 키**입니다.
    *   TGS는 이 세션 키를, 클라이언트와 TGS만이 아는 키로 암호화하여 클라이언트에게 전달합니다. 따라서 클라이언트는 이 암호를 풀어 세션 키를 얻을 수 있습니다.

**최종 서버와의 통신 과정:**

1.  클라이언트는 위에서 받은 두 가지, 즉 **(1) 서비스 티켓**과 **(2) 클라이언트-서버 세션 키**를 갖게 됩니다.
2.  클라이언트는 (2)번 세션 키를 사용하여 자신의 신원 정보를 담은 인증자(Authenticator)를 암호화합니다.
3.  클라이언트는 **(1) 서비스 티켓**과 **암호화된 인증자**를 최종 서버에 보냅니다.
4.  최종 서버는 자신의 비밀 키로 **서비스 티켓**을 열어봅니다. 그 안에서 **클라이언트-서버 세션 키**를 꺼냅니다.
5.  이제 서버도 클라이언트와 동일한 세션 키를 갖게 되었습니다. 서버는 이 세션 키를 사용하여 클라이언트가 보낸 **암호화된 인증자**를 해독합니다.
6.  인증자가 성공적으로 해독되면, 서버는 클라이언트를 신뢰하고 통신을 시작합니다. 이 통신은 이제 둘만이 아는 세션 키로 안전하게 암호화될 수 있습니다.

**요약:**
서비스 티켓은 그 자체로 비밀 키가 아니라, **클라이언트와 최종 서버가 사용할 실제 비밀 키(세션 키)를 최종 서버에게 안전하게 전달해 주는 역할**을 합니다.

### Q: 그럼 TGS가 최종서버와 키를 공유하는 과정이 있겠네요?

정확한 추론입니다. 하지만 그 과정은 클라이언트의 인증 요청이 있을 때마다 실시간으로 일어나는 것은 아니고, **미리 설정되는 단계**가 있습니다.

사용자의 생각: "TGS가 최종 서버와 키를 공유하는 과정"
정확한 개념: "**최종 서버가 KDC(TGS 포함)에 등록될 때, 둘만 아는 비밀 키를 미리 설정하고 공유**"

다음과 같이 진행됩니다.

1.  **서비스 등록 (사전 단계):**
    *   네트워크 관리자가 새로운 서비스(최종 서버)를 케르베로스 시스템에 추가할 때, 먼저 해당 서비스를 **KDC에 등록**합니다.
    *   이 등록 과정에서, 해당 **서비스만을 위한 고유한 비밀 키(Service Secret Key)**가 생성됩니다.
    *   이 비밀 키는 **오직 KDC(AS와 TGS 포함)와 해당 최종 서버만**이 알게 되며, 각각의 시스템에 안전하게 저장됩니다. 이 키는 한 번 설정되면 바뀌지 않는 장기 키(long-term key)입니다.

2.  **TGS의 역할 (클라이언트 인증 시):**
    *   이제 클라이언트가 해당 최종 서버에 접근하기 위해 TGS에 서비스 티켓을 요청합니다.
    *   TGS는 자신의 데이터베이스에서 해당 최종 서버에 대해 **미리 등록된 비밀 키**를 찾습니다.
    *   TGS는 이 키를 사용하여, 클라이언트에게 발급할 서비스 티켓을 암호화합니다.

**결론:**

TGS가 인증 시점에 최종 서버와 동적으로 키를 교환하는 것이 아닙니다. 대신, 최종 서버가 시스템에 처음 도입될 때 KDC와 비밀 키를 공유해두고, TGS는 필요할 때마다 그 **미리 공유된 키**를 사용하여 서비스 티켓을 만드는 것입니다.

이 구조 덕분에, TGS가 발급한 서비스 티켓은 오직 해당 최종 서버만이 해독할 수 있으며, 서버는 티켓을 성공적으로 해독함으로써 그 티켓이 신뢰할 수 있는 TGS로부터 왔음을 확신할 수 있습니다.